<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ferremax</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    body {
        background-color: darkslategrey;
        color: whitesmoke;
    }
    table {
      background-color: #2e2e2e;
      color: white;
    }
    th, td {
      border: 1px solid #555;
      color: white;
    }
    th {
      background-color: #444;
      color: white;
    }
    h1, h2 {
      color: white;
    }
  </style>
</head>
<body>
  <a href="index.html" class="btn btn-danger"><i class="fas fa-arrow-left"></i> Volver</a>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Pedidos Pendientes</h1>
        <div class="row">
          <div class="col-md-6">
            <h2>Retiros</h2>
            <table id="tabla-retiro" class="table table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ID Venta</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Datos de retiros -->
              </tbody>
            </table>
          </div>
          <div class="col-md-6">
            <h2>Despachos</h2>
            <table id="tabla-despacho" class="table table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ID Venta</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Datos de despachos -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

  <!-- Bootstrap JavaScript y dependencias -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
        window.onload = function() {
            // Fetch para obtener pedidos pendientes
            fetch('http://localhost:5001/api/pendientes')
            .then(response => {
                    if (!response.ok) {
                        throw new Error('La respuesta de la red no fue correcta');
                    }
                    return response.json();
                })
                .then(data => {
                    var tabla_retiro = document.querySelector('#tabla-retiro tbody');
                    var tabla_despacho = document.querySelector('#tabla-despacho tbody');
                    data.entregas_pendientes.forEach(dato => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${dato.id}</td>
                            <td>${dato.id_orden}</td>
                            <td>${dato.estado}</td>
                            <td><a class="btn btn-primary btn-block" onclick="confirmarEntrega('${dato.id}')">Entregar</a></td>
                        `;
                        tabla_retiro.appendChild(row);
                    });
                    data.despachos_pendientes.forEach(dato => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${dato.id}</td>
                            <td>${dato.id_orden}</td>
                            <td>${dato.estado}</td>
                            <td><a class="btn btn-primary btn-block" onclick="confirmarEntrega('${dato.id}')">Entregar</a></td>
                        `;
                        tabla_despacho.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Ha habido un problema con su operación de recuperación:', error);
                });
        }
        
        function confirmarEntrega(id_entrega) {
            if (confirm("¿Está de acuerdo en marcar esta orden como entregada?")) {
                entregarOrden(id_entrega);
            }
        }

        function entregarOrden(id_entrega) {
            const data = {
                estado: 'Entregado'
            };
            fetch('http://localhost:5001/api/entrega/' + id_entrega, {
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                },
                method: 'PUT',
                mode: 'cors',
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                alert('La orden ha sido marcada como entregada exitosamente.');
                location.reload();  // Recargar la página para actualizar la tabla
            })
            .catch(error => {
                console.error('Error al actualizar la orden:', error);
                alert('Hubo un problema al marcar la orden como entregada.');
            });
        }
  </script>
</body>
</html>
